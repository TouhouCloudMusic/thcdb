# Recommendation (推荐) 模块

> **实现状态**: ❌ 未实现 | [查看路线图](../ROADMAP.md#recommendation)

推荐系统帮助用户发现感兴趣的内容，基于标签相似度和内容关联提供简单有效的推荐。

## 系统概述

THCDB 采用基于标签的简单推荐策略：

- **相似内容推荐**: 基于共同标签找到相似的实体
- **关联内容推荐**: 基于实体间的关系推荐相关内容

## 基于标签的推荐

### 相似度计算

使用 Jaccard 相似度计算两个实体间的标签相似度：

```
similarity(A, B) = |tags(A) ∩ tags(B)| / |tags(A) ∪ tags(B)|
```

### 推荐流程

1. 获取目标实体的所有标签
2. 查找拥有相同标签的其他实体
3. 计算标签重叠度
4. 按相似度排序返回

### 标签权重

不同类型的标签可以有不同权重：

| 标签类型 | 权重 | 说明 |
|---------|------|------|
| Genre | 1.0 | 流派标签，核心分类 |
| Descriptor | 0.8 | 描述性标签 |
| Scene | 0.6 | 场景标签 |
| Movement | 0.5 | 运动/风潮标签 |

加权相似度计算：

```
weighted_similarity(A, B) =
    Σ(weight(tag) for tag in tags(A) ∩ tags(B)) /
    Σ(weight(tag) for tag in tags(A) ∪ tags(B))
```

## 关联内容推荐

### 歌曲推荐

基于当前歌曲推荐：

- **同发行版本**: 同一张专辑的其他歌曲
- **同艺人**: 同一艺人的其他歌曲
- **相似标签**: 标签相似的其他歌曲

### 发行版本推荐

基于当前发行版本推荐：

- **同艺人**: 艺人的其他发行版本
- **同活动**: 同一活动的其他发行版本
- **同厂牌**: 同一厂牌的其他发行版本
- **相似标签**: 标签相似的其他发行版本

### 艺人推荐

基于当前艺人推荐：

- **成员关系**: 成员的其他项目、所属组合
- **合作艺人**: 经常合作的其他艺人
- **相似标签**: 标签相似的其他艺人

## 推荐策略

### 混合推荐

每种实体类型的推荐结果混合多种来源：

```
recommendations = [
    tag_based_recommendations (60%),
    relation_based_recommendations (40%)
]
```

### 去重和过滤

- 去除用户已喜欢的内容（可配置）
- 去除用户已浏览的内容（可配置）
- 去除重复推荐

### 结果限制

- 默认返回 10 条推荐
- 最大返回 50 条
- 支持分页

## 性能优化

### 预计算

- 热门实体的相似实体列表预计算
- 每日更新预计算结果

### 缓存

- 推荐结果缓存 1 小时
- 使用 Redis 存储预计算结果
- 缓存键: `rec:{entity_type}:{entity_id}:{rec_type}`

### 降级策略

当推荐数据不足时：

- 返回热门内容
- 返回最新内容
- 返回随机内容

## 数据依赖

推荐系统依赖以下数据的完善程度：

- **标签数据**: 实体需要有足够的标签才能进行相似度推荐
- **关系数据**: 艺人、发行版本、活动之间的关联关系

### 冷启动处理

对于标签不足的新实体：

- 优先显示关联推荐（同艺人、同厂牌）
- 显示同类型热门内容
- 引导用户添加标签

## API 端点 (待实现)

### 相似内容

| 端点 | 方法 | 说明 |
|------|------|------|
| `/song/{id}/similar` | GET | 相似歌曲 |
| `/release/{id}/similar` | GET | 相似发行版本 |
| `/artist/{id}/similar` | GET | 相似艺人 |

### 关联内容

| 端点 | 方法 | 说明 |
|------|------|------|
| `/artist/{id}/other-releases` | GET | 艺人其他作品 |
| `/song/{id}/same-release` | GET | 同专辑歌曲 |
| `/release/{id}/same-event` | GET | 同活动发行版本 |
| `/release/{id}/same-label` | GET | 同厂牌发行版本 |

### 综合推荐

| 端点 | 方法 | 说明 |
|------|------|------|
| `/{entity_type}/{id}/recommendations` | GET | 综合推荐 |

### 查询参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `limit` | int | 10 | 返回数量 (最大 50) |
| `offset` | int | 0 | 分页偏移 |
| `exclude_liked` | bool | false | 排除已喜欢 |
